# ==========================================================
# ğŸ“¦ CI å·¥ä½œæµï¼šè‡ªåŠ¨æµ‹è¯• + æ„å»º + æ¨é€ Docker é•œåƒ
# ä½œè€…ï¼šHu Rongze
# ==========================================================
name: CI to Docker Hub

on:
  push:
    branches: ["main"]   # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆç›¸å½“äº git cloneï¼‰
      # ------------------------------------------------------
      - name: ğŸ§© Checkout code
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® Python ç¯å¢ƒï¼ˆç”¨äºè¿è¡Œ pytestï¼‰
      # ------------------------------------------------------
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------
      # ç¬¬ 3 æ­¥ï¼šç¼“å­˜ pip ä¾èµ–ï¼ˆèŠ‚çœæ„å»ºæ—¶é—´ï¼‰
      # ------------------------------------------------------
      - name: â™»ï¸ Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ------------------------------------------------------
      # ç¬¬ 4 æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶è¿è¡Œå†’çƒŸæµ‹è¯•
      # ------------------------------------------------------
      - name: ğŸ§ª Run Smoke Tests
        working-directory: ./app
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…ä¾èµ–..."
          pip install -r requirements.txt
          echo "ğŸ§© å®‰è£… pytest..."
          pip install pytest
          echo "ğŸ§  è¿è¡Œå†’çƒŸæµ‹è¯•..."
          pytest -v --maxfail=1 --disable-warnings
        # âœ… å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¿™ä¸ªæ­¥éª¤ä¼šä¸­æ–­æ•´ä¸ª CI æµç¨‹

      # ------------------------------------------------------
      # ç¬¬ 5 æ­¥ï¼šç™»å½• Docker Hub
      # ------------------------------------------------------
      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ------------------------------------------------------
      # ç¬¬ 6 æ­¥ï¼šç”Ÿæˆæ—¶é—´æˆ³ TAGï¼ˆå¦‚ 2025-10-05-2200ï¼‰
      # ------------------------------------------------------
      - name: ğŸ•’ Set up image tag
        id: vars
        run: echo "TAG=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_ENV

      # ------------------------------------------------------
      # ç¬¬ 7 æ­¥ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      # ------------------------------------------------------
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: |
            clarenceze/fullstack-mvp:latest
            clarenceze/fullstack-mvp:${{ env.TAG }}

      # ------------------------------------------------------
      # ç¬¬ 8 æ­¥ï¼šæ¸…ç†æ—§ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¿ç•™æœ€æ–° 10 ä¸ª + latestï¼‰
      # ------------------------------------------------------
      - name: ğŸ§¹ Clean up old Docker Hub tags
        run: |
          echo "ğŸ§¾ è·å– Docker Hub æ ‡ç­¾åˆ—è¡¨..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST -d '{"username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/?page_size=100 \
            | jq -r '.results[].name' | grep -v latest)

          COUNT=$(echo "$TAGS" | wc -l)
          echo "ğŸ“Š å½“å‰æ ‡ç­¾æ•°é‡: $COUNT"

          if [ $COUNT -gt 10 ]; then
            DELETE_TAGS=$(echo "$TAGS" | tail -n +11)
            for tag in $DELETE_TAGS; do
              echo "ğŸš® åˆ é™¤æ—§æ ‡ç­¾: $tag"
              curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
                https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/$tag/
            done
          else
            echo "âœ¨ æ— éœ€æ¸…ç†ï¼Œæ ‡ç­¾æ•°é‡ <= 10"
          fi
