name: CD - Deploy to ECS Server

on:
  workflow_run:
    workflows: ["CI2 - Build & Push Docker Image"]
    types: [completed]
  workflow_dispatch:
    inputs:
      manual:
        description: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼ˆè°ƒè¯•ä½¿ç”¨ï¼‰'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      # -------------------------------
      # ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      # -------------------------------
      - name: ðŸš€ éƒ¨ç½²è‡³ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… å¼€å§‹è‡ªåŠ¨éƒ¨ç½² fullstack-mvp ..."
            cd /root/fullstack-mvp
            echo "ðŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ ..."
            docker compose pull app
            echo "â™»ï¸ é‡æ–°å¯åŠ¨å®¹å™¨ ..."
            docker compose up -d --force-recreate app
            echo "ðŸ§¹ æ¸…ç†æœªä½¿ç”¨é•œåƒ ..."
            docker image prune -af --filter "until=24h"

      # -------------------------------
      # ðŸ©º å¥åº·æ£€æŸ¥ï¼ˆæ£€æµ‹ /healthï¼‰
      # -------------------------------
      - name: ðŸ©º å¥åº·æ£€æŸ¥
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ©º æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
            sleep 10
            if curl -fs http://localhost:8000/health; then
              echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºä»¥è§¦å‘å›žæ»š"
              exit 1
            fi

      # -------------------------------
      # ðŸ” è‡ªåŠ¨å›žæ»š + åˆ é™¤é”™è¯¯é•œåƒ
      # -------------------------------
      - name: ðŸ” è‡ªåŠ¨å›žæ»šï¼ˆè‹¥å¥åº·æ£€æŸ¥å¤±è´¥ï¼‰
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ‰§è¡Œå›žæ»šé€»è¾‘..."

            # 1ï¸âƒ£ èŽ·å–å½“å‰ä¸Žä¸Šä¸€ä¸ªé•œåƒ tag
            CURRENT_TAG=$(docker images clarenceze/fullstack-mvp --format "{{.Tag}}" | grep -v latest | sort -r | sed -n '1p')
            PREV_TAG=$(docker images clarenceze/fullstack-mvp --format "{{.Tag}}" | grep -v latest | sort -r | sed -n '2p')
            echo "ðŸ§¾ å½“å‰å¤±è´¥ç‰ˆæœ¬: $CURRENT_TAG"
            echo "ðŸ§¾ ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬: $PREV_TAG"

            # 2ï¸âƒ£ å›žæ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬é•œåƒ
            if [ -n "$PREV_TAG" ]; then
              docker pull clarenceze/fullstack-mvp:$PREV_TAG
              docker tag clarenceze/fullstack-mvp:$PREV_TAG clarenceze/fullstack-mvp:latest
              docker compose up -d --force-recreate app
              echo "âœ… å·²å›žæ»šè‡³ clarenceze/fullstack-mvp:$PREV_TAG"
            else
              echo "âŒ æ— æ³•æ‰¾åˆ°ä¸Šä¸€ä¸ªé•œåƒç‰ˆæœ¬ï¼Œå›žæ»šå¤±è´¥"
              exit 1
            fi

            # 3ï¸âƒ£ ç™»å½• Docker Hub
            echo "ðŸ”‘ ç™»å½• Docker Hub ..."
            TOKEN=$(curl -s -H "Content-Type: application/json" \
              -X POST -d '{"username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}' \
              https://hub.docker.com/v2/users/login/ | jq -r .token)

            # 4ï¸âƒ£ åˆ é™¤äº‘ç«¯é”™è¯¯é•œåƒ tagï¼ˆéž latestï¼‰
            if [ -n "$CURRENT_TAG" ]; then
              echo "ðŸ§¹ åˆ é™¤ Docker Hub ä¸Šçš„é”™è¯¯é•œåƒ tag: $CURRENT_TAG ..."
              curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
                https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/$CURRENT_TAG/ || true
              echo "âœ… å·²ä»Ž Docker Hub åˆ é™¤é”™è¯¯é•œåƒï¼š$CURRENT_TAG"
            fi

            # 5ï¸âƒ£ æ›´æ–° latest æŒ‡å‘æ—§ç‰ˆæœ¬
            echo "ðŸ” é‡æ–°æŽ¨é€æ—§ç‰ˆæœ¬ä¸º latest ..."
            docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"
            docker push clarenceze/fullstack-mvp:latest
            echo "ðŸŽ¯ latest å·²æ›´æ–°ä¸ºç¨³å®šç‰ˆæœ¬ï¼š$PREV_TAG"

      # -------------------------------
      # âœ… éƒ¨ç½²ç»“æžœæ€»ç»“
      # -------------------------------
      - name: âœ… Summary
        if: success()
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- å½“å‰é•œåƒ: clarenceze/fullstack-mvp:latest" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: å¥åº·æ£€æŸ¥é€šè¿‡ âœ…" >> $GITHUB_STEP_SUMMARY

      - name: âš ï¸ Failure Summary
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå·²è§¦å‘è‡ªåŠ¨å›žæ»šå¹¶åˆ é™¤é”™è¯¯é•œåƒ" >> $GITHUB_STEP_SUMMARY
