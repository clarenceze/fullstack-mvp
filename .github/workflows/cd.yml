name: CD - Deploy to ECS Server

on:
  workflow_run:
    workflows: ["CI2 - Build & Push Docker Image"]
    types: [completed]
  workflow_dispatch:
    inputs:
      manual:
        description: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    steps:
      - name: ğŸš€ éƒ¨ç½²è‡³ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âœ… å¼€å§‹è‡ªåŠ¨éƒ¨ç½² fullstack-mvp ..."
            cd /root/fullstack-mvp
            docker compose pull app
            docker compose up -d --force-recreate app
            docker image prune -f

      - name: ğŸ©º å¥åº·æ£€æŸ¥ï¼ˆå¸¦é”™è¯¯æ—¥å¿—ï¼‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ©º æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
            sleep 10

            # 1ï¸âƒ£ æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
            if ! docker ps --filter "name=app" --format '{{.Names}}' | grep -q "app"; then
              echo "âŒ åº”ç”¨å®¹å™¨æœªè¿è¡Œï¼å¯èƒ½å¯åŠ¨å¤±è´¥"
              docker ps -a
              docker logs app || true
              exit 1
            fi

            # 2ï¸âƒ£ æ£€æŸ¥å®¹å™¨æ—¥å¿—ä¸­æ˜¯å¦æœ‰æ˜æ˜¾é”™è¯¯
            echo "ğŸ“œ æœ€è¿‘å®¹å™¨æ—¥å¿—ï¼ˆ30 è¡Œï¼‰:"
            docker logs app | tail -n 30

            # 3ï¸âƒ£ è®¿é—® /health å¹¶æ•è·çŠ¶æ€ç ä¸è¿”å›å†…å®¹
            STATUS_CODE=$(curl -k -s -o response.txt -w "%{http_code}" --connect-timeout 8 https://api.clarenceze.com/api/health || echo 000)
            echo "ğŸ“¡ HTTP çŠ¶æ€ç : $STATUS_CODE"
            echo "ğŸ“¦ è¿”å›å†…å®¹:"
            cat response.txt || true

            # 4ï¸âƒ£ åˆ¤æ–­å¥åº·çŠ¶å†µ
            if [ "$STATUS_CODE" -eq 200 ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $STATUS_CODE"
              echo "ğŸ§  å¯èƒ½åŸå› ï¼š"
              echo "  - åº”ç”¨æœªç›‘å¬ 8000 ç«¯å£"
              echo "  - /health è·¯ç”±æŠ¥é”™æˆ–æœªæ³¨å†Œ"
              echo "  - ç¯å¢ƒå˜é‡é”™è¯¯æˆ–ä¾èµ–åŠ è½½å¤±è´¥"
              echo "  - Docker Compose æœªæ­£ç¡®å¯åŠ¨"
              exit 1
            fi


      - name: ğŸ” è‡ªåŠ¨å›æ»šï¼ˆè‹¥å¥åº·æ£€æŸ¥å¤±è´¥ï¼‰
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹æ‰§è¡ŒåŸºäº Docker Hub çš„è¿œç¨‹å›æ»š ..."

            # 1ï¸âƒ£ ç™»å½• Docker Hub å¹¶è·å– token
            TOKEN=$(curl -s -H "Content-Type: application/json" \
              -X POST -d '{"username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}' \
              https://hub.docker.com/v2/users/login/ | jq -r .token)

            # 2ï¸âƒ£ ä» Docker Hub è·å–æœ€è¿‘ä¸¤ä¸ªç‰ˆæœ¬ tagï¼ˆæ’é™¤ latestï¼‰
            TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
              https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/?page_size=10 \
              | jq -r '.results[].name' | grep -v latest | head -n 2)

            CURRENT_TAG=$(echo "$TAGS" | sed -n '1p')
            PREV_TAG=$(echo "$TAGS" | sed -n '2p')

            echo "ğŸ§¾ å½“å‰å¤±è´¥ç‰ˆæœ¬(äº‘ç«¯): $CURRENT_TAG"
            echo "ğŸ§¾ ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬(äº‘ç«¯): $PREV_TAG"

            # 3ï¸âƒ£ å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
            if [ -n "$PREV_TAG" ]; then
              echo "ğŸ”„ å›æ»šä¸­..."
              docker pull clarenceze/fullstack-mvp:$PREV_TAG
              docker tag clarenceze/fullstack-mvp:$PREV_TAG clarenceze/fullstack-mvp:latest
              docker compose up -d --force-recreate app
              echo "âœ… å·²å›æ»šè‡³ clarenceze/fullstack-mvp:$PREV_TAG"
            else
              echo "âš ï¸ äº‘ç«¯æœªæ‰¾åˆ°æ—§ç‰ˆæœ¬ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å›æ»š"
              exit 0
            fi

            # 4ï¸âƒ£ åˆ é™¤äº‘ç«¯é”™è¯¯é•œåƒ tag
            if [ -n "$CURRENT_TAG" ]; then
              echo "ğŸ§¹ åˆ é™¤ Docker Hub ä¸Šçš„é”™è¯¯é•œåƒ tag: $CURRENT_TAG ..."
              curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
                https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/$CURRENT_TAG/ || true
              echo "âœ… å·²åˆ é™¤é”™è¯¯é•œåƒï¼š$CURRENT_TAG"
            fi

            # 5ï¸âƒ£ é‡æ–°æ¨é€æ—§é•œåƒä¸º latest
            echo "ğŸ” æ›´æ–° latest æŒ‡å‘æ—§ç‰ˆæœ¬ $PREV_TAG ..."
            docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"
            docker push clarenceze/fullstack-mvp:latest
            echo "ğŸ¯ å›æ»šå®Œæˆï¼šlatest å·²æ›´æ–°ä¸ºç¨³å®šç‰ˆæœ¬ $PREV_TAG"

