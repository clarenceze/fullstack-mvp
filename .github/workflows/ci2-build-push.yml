name: CI2 - Build & Push Docker Image

on:
  workflow_run:
    workflows: ["CI1 - Test & Security Scan"]
    types:
      - completed
  workflow_dispatch:  # âœ… æ‰‹åŠ¨è§¦å‘å…¥å£ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: â™»ï¸ Enable Docker layer cache
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ github.ref_name }}-

      - name: ðŸ•’ Set up image tag
        id: vars
        run: |
          echo "TAG=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_ENV
          echo "ðŸ”– TAG=${TAG}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ§± Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: |
            clarenceze/fullstack-mvp:latest
            clarenceze/fullstack-mvp:${{ env.TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ§¹ Clean up old Docker Hub tags
        run: |
          echo "ðŸ§¾ Fetching tags from Docker Hub..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST -d '{"username": "${{ secrets.DOCKER_USERNAME }}", "password": "${{ secrets.DOCKER_PASSWORD }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/?page_size=100 \
            | jq -r '.results[].name' | grep -v latest)

          COUNT=$(echo "$TAGS" | wc -l)
          echo "Total tags: $COUNT"

          if [ $COUNT -gt 10 ]; then
            DELETE_TAGS=$(echo "$TAGS" | tail -n +11)
            for tag in $DELETE_TAGS; do
              # é¿å…è¯¯åˆ ç¨³å®šåˆ†æ”¯
              if [[ "$tag" =~ ^20[0-9]{2}-[0-9]{2}-[0-9]{2} ]]; then
                echo "Deleting old tag: $tag"
                curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
                  https://hub.docker.com/v2/repositories/clarenceze/fullstack-mvp/tags/$tag/
              fi
            done
          else
            echo "No cleanup needed."
          fi

      - name: âœ… Summary
        if: success()
        run: |
          echo "âœ… Docker é•œåƒå·²æˆåŠŸæž„å»ºå¹¶æŽ¨é€" >> $GITHUB_STEP_SUMMARY
          echo "- Image: clarenceze/fullstack-mvp:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- Cache: æŒä¹…åŒ–å¯ç”¨" >> $GITHUB_STEP_SUMMARY
