# ============================================================
# ğŸ ä½¿ç”¨ Python 3.11 è½»é‡ç‰ˆé•œåƒï¼ˆé€‚åˆéƒ¨ç½²ï¼‰
# ============================================================
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•ä¸ç¯å¢ƒå˜é‡
WORKDIR /app
ENV PYTHONPATH=/app

# ============================================================
# ğŸ§° å®‰è£…ç³»ç»Ÿä¾èµ–
# ============================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libpq-dev curl && \
    rm -rf /var/lib/apt/lists/*

# ============================================================
# ğŸ“¦ å®‰è£… Python ä¾èµ–ï¼ˆå…ˆå¤åˆ¶ requirements ä»¥åˆ©ç”¨ç¼“å­˜ï¼‰
# ============================================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ============================================================
# ğŸ“‚ æ‹·è´å®Œæ•´é¡¹ç›®æºç ä¸æ•°æ®æ–‡ä»¶
# ============================================================
COPY . /app
COPY ../data /app/data     # âœ… ä¿®æ­£è·¯å¾„ï¼Œç¡®ä¿èƒ½ä»ä»“åº“æ ¹ç›®å½•å¤åˆ¶ data æ–‡ä»¶å¤¹


# ============================================================
# ğŸŒ æš´éœ²å®¹å™¨ç«¯å£
# ============================================================
EXPOSE 8000

# ============================================================
# ğŸš€ å®¹å™¨å¯åŠ¨æ—¶ï¼šå…ˆåˆå§‹åŒ–æ•°æ®åº“ï¼Œå†å¯åŠ¨æœåŠ¡
# ============================================================
CMD bash -c "\
    echo 'ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè‹¥å·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰...' && \
    python scripts/init_db.py || echo 'âš ï¸ æ•°æ®åˆå§‹åŒ–è·³è¿‡ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰' && \
    echo 'ğŸš€ å¯åŠ¨ FastAPI æœåŠ¡...' && \
    uvicorn main:app --host 0.0.0.0 --port 8000"
