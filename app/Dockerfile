# ============================================================
# 🐍 使用 Python 3.11 轻量版镜像（适合部署）
# ============================================================
FROM python:3.11-slim

# 设置工作目录与环境变量
WORKDIR /app
ENV PYTHONPATH=/app

# ============================================================
# 🧰 安装系统依赖
# ============================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libpq-dev curl && \
    rm -rf /var/lib/apt/lists/*

# ============================================================
# 📦 安装 Python 依赖（先复制 requirements 以利用缓存）
# ============================================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ============================================================
# 📂 拷贝完整项目源码与数据文件
# ============================================================
COPY . /app
COPY ../data /app/data     # ✅ 修正路径，确保能从仓库根目录复制 data 文件夹


# ============================================================
# 🌍 暴露容器端口
# ============================================================
EXPOSE 8000

# ============================================================
# 🚀 容器启动时：先初始化数据库，再启动服务
# ============================================================
CMD bash -c "\
    echo '🔧 初始化数据库（若已存在则跳过）...' && \
    python scripts/init_db.py || echo '⚠️ 数据初始化跳过（可能已存在）' && \
    echo '🚀 启动 FastAPI 服务...' && \
    uvicorn main:app --host 0.0.0.0 --port 8000"
